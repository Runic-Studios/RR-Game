name: Build and Push RR-Game

on:
  push:
    branches:
      - '**'

env:
  PROJECT_NAME: 'RR Game'
  ARTIFACT_NAME: 'rr-game'
  REGISTRY: 'registry.runicrealms.com'
  REGISTRY_PROJECT: 'library'

jobs:
  build-and-push:
    runs-on: rr-runner
    container:
      image: registry.runicrealms.com/agents/agent-java-21:latest
      credentials:
        username: ${{ secrets.HARBOR_USERNAME }}
        password: ${{ secrets.HARBOR_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Environment
        id: env
        uses: Runic-Studios/Realm-Actions/determine-env@main

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false
          gradle-home-cache-includes: |
            caches
            wrapper
            notifications
            jdks

      - name: Build with Gradle
        run: ./gradlew :plugin:shadowJar --no-daemon

      - name: Get Short SHA
        id: vars
        run: echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Push Artifact to ORAS
        uses: Runic-Studios/Realm-Actions/oras-push@main
        with:
          artifact_name: ${{ env.ARTIFACT_NAME }}
          tag: ${{ steps.vars.outputs.sha_short }}
          file_path: 'plugin/build/libs/game-plugin-all.jar'
          registry: ${{ env.REGISTRY }}
          registry_project: ${{ env.REGISTRY_PROJECT }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Update Realm-Paper Manifest
        uses: Runic-Studios/Realm-Actions/update-manifest@main
        with:
          repository: 'Realm-Paper'
          branch: 'dev'
          file_path: 'artifact-manifest.yaml'
          yq_path: '.artifacts["${{ env.ARTIFACT_NAME }}"].tag'
          new_value: ${{ steps.vars.outputs.sha_short }}
          ssh_key: ${{ secrets.BOT_SSH_KEY }}
          commit_message: 'Update ${{ env.ARTIFACT_NAME }} tag to ${{ steps.vars.outputs.sha_short }}'

      - name: Create PR (Main Only)
        if: steps.env.outputs.run_main_deploy == 'true'
        uses: Runic-Studios/Realm-Actions/create-pr@main
        with:
          repository: 'Realm-Paper'
          base: 'main'
          head: 'dev'
          title: 'AUTOGENERATED: Promote latest RR-Game image/artifact to production'
          body: 'This PR promotes the latest tested RR-Game build from dev to production.'
          gh_token: ${{ secrets.BOT_PAT }}
